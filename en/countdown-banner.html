<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://assets.adobedtm.com/253f5bd08be2/5032e2df9891/launch-bc3421bc8941-development.min.js" async></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.6.0/mdb.min.css" rel="stylesheet" />
    <script type="text/javascript" src="../colorpicker/js/jquery-1.9.1.js"></script>
    <link rel="stylesheet" href="../colorpicker/css/custom-spectrum.css" />
    <script src="../colorpicker/js/spectrum.js"></script>

    <style>
      body {
        margin: 20px;
      }

      #preview {
        border: 0px solid;
        width: 50%;
        height: 500px;
      }

      #setting {
        margin: 20px;
      }
    </style>
  </head>

  <body>
    <h1>Modal Dialog Editor for Count Down Banner v.0616-2022</h1>
    <input type="button" id="show" value="show" />
    <hr />

    <div style="display: flex">
      <!------------------------ ------------->
      <div id="preview"></div>
      <div id="setting">
        <form>
          <table>
            <tr>
              <td>Image URL</td>
              <td>
                <input id="image_url" type="text" name="img_url" size="60" value="https://tetsushijp.github.io/atdialogeditor/img/AdobeStock_487161198xsmall.jpeg" />
              </td>
            </tr>
            <tr>
              <td>Link URL</td>
              <td><input id="link_url" type="text" name="link_url" size="60" value="https://www.adobe.com/" /></td>
            </tr>
            <tr>
              <td>Count Down Target Date</td>
              <td><input id="banner_CD_date" type="text" name="banner_CD_date" value="2022/06/23 12:00" /></td>
            </tr>
            <tr>
              <td>Text Color</td>
              <td>
                <input type="text" id="ft_color" name="ft_color" value="#FFF" />
              </td>
            </tr>
            <tr>
              <td>Background Color</td>
              <td>
                <input type="text" id="bk_color" name="bk_color" value="#D6563A" />
              </td>
            </tr>
            <tr>
              <td colspan="2"><hr /></td>
            </tr>
            <tr>
              <td>Scroll range to display</td>
              <td><input id="showScrollY" type="text" name="showScrollY" size="6" value="0" /> % - <input id="hideScrollY" type="text" name="hideScrollY" size="6" value="100" /> %</td>
            </tr>
            <tr>
              <td></td>
              <td>&</td>
            </tr>
            <tr>
              <td>Display start - end time (milliseconds)</td>
              <td><input id="showStartTime" type="text" name="showStartTime" size="6" value="500" /> ms - <input id="showEndTime" type="text" name="showEndTime" size="6" value="" /> ms</td>
            </tr>
            <tr>
              <td colspan="2"><hr /></td>
            </tr>
            <tr>
              <td colspan="2">
                <label>Display Location for PC</label>
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <style>
                  .banner-position {
                    display: flex;
                    width: 360px;
                    flex-wrap: wrap;
                    background-color: #eee;
                  }
                  .position-item {
                    width: 80px;
                    height: 50px;
                    background-color: #aaa;
                    margin: 20px;
                    border-radius: 8px;
                  }
                  .position-item:hover {
                    background-color: pink;
                  }
                  input:checked + label {
                    background-color: red;
                  }
                  .radiobtn {
                    display: none;
                  }
                </style>
                <div class="banner-position">
                  <input class="radiobtn" type="radio" id="SPlt" name="posLRTB" value="lt" /><label for="SPlt" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="SPct" name="posLRTB" value="ct" /><label for="SPct" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="SPrt" name="posLRTB" value="rt" /><label for="SPrt" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="SPlc" name="posLRTB" value="lc" /><label for="SPlc" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="SPcc" name="posLRTB" value="cc" /><label for="SPcc" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="SPrc" name="posLRTB" value="rc" /><label for="SPrc" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="SPlb" name="posLRTB" value="lb" /><label for="SPlb" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="SPcb" name="posLRTB" value="cb" /><label for="SPcb" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="SPrb" name="posLRTB" value="rb" checked /><label for="SPrb" class="position-item"></label>
                </div>
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <br />
                <label>Display Location for Smart Phone</label>
              </td>
            </tr>
            <tr>
              <td colspan="2">
                <div class="banner-position">
                  <input class="radiobtn" type="radio" id="lt" name="SPposLRTB" value="lt" /><label for="lt" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="ct" name="SPposLRTB" value="ct" /><label for="ct" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="rt" name="SPposLRTB" value="rt" /><label for="rt" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="lc" name="SPposLRTB" value="lc" /><label for="lc" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="cc" name="SPposLRTB" value="cc" /><label for="cc" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="rc" name="SPposLRTB" value="rc" /><label for="rc" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="lb" name="SPposLRTB" value="lb" /><label for="lb" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="cb" name="SPposLRTB" value="cb" checked /><label for="cb" class="position-item"></label>
                  <input class="radiobtn" type="radio" id="rb" name="SPposLRTB" value="rb" /><label for="rb" class="position-item"></label>
                </div>
              </td>
            </tr>
            <!--/* <tr>
              <td colspan="2"><hr /></td>
            </tr> */-->
            <!--/* <tr>
              <td colspan="2">
                <label><input type="checkbox" id="detail" /> Template Editor </label>
              </td>
            </tr> */-->
            <tr>
              <td colspan="2"><textarea id="banner_template" cols="120" rows="16"></textarea></td>
            </tr>
            <tr>
              <td colspan="2"><hr /></td>
            </tr>
            <tr>
              <td colspan="2">
                <input type="button" value=" Code Generate " id="ok" />
              </td>
            </tr>
            <tr>
              <td colspan="2"><textarea id="bannerSource" cols="120" rows="16"></textarea></td>
            </tr>
          </table>
        </form>
        <!--- ソース -->
        <div></div>
      </div>
    </div>

    <script>
      // ################################################################################################################
      // ########################### Editor Contorl ######################################################################
      document.getElementById("showScrollY").addEventListener("change", function (e) {
        eval(getShowDialogFunc());
      });
      document.getElementById("hideScrollY").addEventListener("change", function (e) {
        eval(getShowDialogFunc());
      });
      $(".position-item").on("click", function () {
        var PCposition = $('input:radio[name="posLRTB"]:checked').val();
        var SPposition = $('input:radio[name="SPposLRTB"]:checked').val();
        // left:30px; bottom:30px;
        console.log("pc:" + PCposition + " SP:" + SPposition);
        initBanner();
      });
      // ===================================================================
      document.getElementById("image_url").addEventListener("change", function (e) {
        var imageURL = window.document.forms[0].image_url.value;
        document.getElementById("bannerImg").src = imageURL;
      });
      document.getElementById("link_url").addEventListener("change", function (e) {
        var linkURL = window.document.forms[0].link_url.value;
        document.getElementById("bannerLink").href = linkURL;
      });
      document.getElementById("banner_CD_date").addEventListener("change", function (e) {
        bannerCDTargetDate = new Date(document.getElementById("banner_CD_date").value);
      });
      // ========================
      document.getElementById("banner_template").addEventListener("change", function (e) {
        var templateHTML = window.document.forms[0].banner_template.value;
        document.getElementById("preview").innerHTML = templateHTML;
        formvalue_update();
      });
      document.getElementById("banner_template").style.display = "none";
      //document.getElementById("detail").addEventListener("change", function (e) {
      //  var detail_check = window.document.forms[0].detail.checked ? "block" : "none";
      //  console.log("detail_check: " + detail_check);
      //  document.getElementById("banner_template").style.display = detail_check;
      //});

      // ================= =================  OK コード出力 ================= =================
      document.getElementById("ok").addEventListener("click", function (e) {
        initBanner();
        var _startTime = window.document.forms[0].showStartTime.value;
        outputscript = getShowDialogFunc() + ";setTimeout(scrollShowHideCheck, " + _startTime + ");";
        outputscript += "var _endTime = '" + window.document.forms[0].showEndTime.value + "';";
        outputscript += "if(_endTime){setTimeout(function(){document.body.removeChild(document.getElementById('ATDialogBase'));}, _endTime);}";
        outputscript += "window.addEventListener('scroll', function () {scrollShowHideCheck();});";

        outputscript = outputscript + "function getBannerHTML() { return '" + getBannerHTML() + "'}";
        outputscript = outputscript + getCDFunc();
        document.getElementById("bannerSource").value = "<" + "script>" + outputscript + "</" + "script>";
      });
      // showのロジックはOKコードと同期させる必要あり todo:実装をもう少しスマートに、、
      document.getElementById("show").addEventListener("click", function (e) {
        initBanner();
        eval(getShowDialogFunc());
        // setTimeout(scrollShowHideCheck, 100);
        setTimeout(scrollShowHideCheck, window.document.forms[0].showStartTime.value);
        var _endTime = "" + window.document.forms[0].showEndTime.value;
        if (_endTime) {
          setTimeout(function () {
            document.body.removeChild(document.getElementById("ATDialogBase"));
          }, _endTime);
        }

        window.addEventListener("scroll", function () {
          scrollShowHideCheck();
        });
        showCountDown();
      });
      function formvalue_update() {
        // 既存のフォームの値を反映
        var imageURL = window.document.forms[0].image_url.value;
        document.getElementById("bannerImg").src = window.document.forms[0].image_url.value;
        var linkURL = window.document.forms[0].link_url.value;
        document.getElementById("bannerLink").href = window.document.forms[0].link_url.value;
        bannerCDTargetDate = new Date(document.getElementById("banner_CD_date").value);
        document.getElementById("ATbanner").style.backgroundColor = window.document.forms[0].bk_color.value;
        document.getElementById("bannerCD").style.color = window.document.forms[0].ft_color.value;
      }
      // ################################################################################################################
      // ########################### Dialog構築部分 ######################################################################
      var positionCSS = {
        lt: "left:30px;top:30px;",
        ct: "left:50%;margin-left:-250px;top:30px;",
        rt: "right:30px;top:30px;",
        lc: "left:30px;top:50%; margin-top:-144px;",
        cc: "left:50%;margin-left:-250px;top:50%;margin-top:-144px;",
        rc: "right:30px;top:50%; margin-top:-144px;",
        lb: "left:30px;bottom:30px;",
        cb: "left:50%;margin-left:-250px;bottom:30px;",
        rb: "right:30px;bottom:30px;",
      };
      var SPpositionCSS = {
        lt: "left:30px;top:30px;",
        ct: "left:50%;margin-left:-180px;top:30px;",
        rt: "right:30px;top:30px;",
        lc: "left:30px;top:50%; margin-top:-80px;",
        cc: "left:50%;margin-left:-180px;top:50%;margin-top:-80px;",
        rc: "right:30px;top:50%; margin-top:-80px;",
        lb: "left:30px;bottom:30px;",
        cb: "left:50%;margin-left:-180px;bottom:30px;",
        rb: "right:30px;bottom:30px;",
      };

      // 初期化
      function initBanner() {
        var positionCSSString = positionCSS[$('input:radio[name="posLRTB"]:checked').val()];
        var SPpositionCSSString = SPpositionCSS[$('input:radio[name="SPposLRTB"]:checked').val()];
        console.log("***** " + positionCSSString + " -- SP:" + SPpositionCSSString);
        var baseTempl =
          `
<div id="ATbanner" style="position:relative;">
  <svg width="32" height="32" style="position:absolute; top:-8px; right:-12px;z-index:9999;" data-name="Livello 1" id="Livello_1" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><circle cx="64" cy="64" r="62" stroke="none" fill="black"/><path stroke="none" fill="none" d="M64,0a64,64,0,1,0,64,64A64.07,64.07,0,0,0,64,0Zm0,122a58,58,0,1,1,58-58A58.07,58.07,0,0,1,64,122Z"/><path fill="white" d="M92.12,35.79a3,3,0,0,0-4.24,0L64,59.75l-23.87-24A3,3,0,0,0,35.88,40L59.76,64,35.88,88a3,3,0,0,0,4.25,4.24L64,68.25l23.88,24A3,3,0,0,0,92.13,88L68.24,64,92.13,40A3,3,0,0,0,92.12,35.79Z"/></svg>
  <a id="bannerLink" href="https://business.adobe.com/jp/products/target/adobe-target.html" target="_blank">
    <img id="bannerImg" width="100%;" max-height="200px" src="http://vizl.chu.jp/www/poc/image-yoko.png">
  </a>
  <div id="bannerCD" style="color: rgb(255, 255, 255);"><div class="_atdialogHMSDiv"><div class="_atdialogHMS"><div>0</div><div class="_atdialogHMSUnit">days</div></div><div class="_atdialogHMS"><div>0</div><div class="_atdialogHMSUnit">hours</div></div><div class="_atdialogHMS"><div>0</div><div class="_atdialogHMSUnit">mins</div></div><div class="_atdialogHMS"><div>0</div><div class="_atdialogHMSUnit">secs</div></div></div><style>._atdialogHMSDiv{display:flex;justify-content: center;}._atdialogHMS{margin-bottom:-5px;margin-right:10px;}._atdialogHMSUnit{margin-top:-10px;font-size:10px;} </style></div>
</div>
<style>
  #ATbanner {box-shadow: 0 0 16px gray;padding:10px;border-radius:10px;width: 500px; background:` +
          window.document.forms[0].bk_color.value +
          `;}
  @media screen and (min-width:769px) {
    #ATDialogBase{z-index:110; position:fixed; ` +
          positionCSSString +
          ` display:flex;}
  }
  @media screen and (max-width:768px) {
    #ATDialogBase{z-index:110; position:fixed; ` +
          SPpositionCSSString +
          ` display:flex;}
    #ATbanner {width: 360px;}
  }
    #bannerCD {text-align:center; color:white; font-size:24px;margin-top:10px;}
</style>`;
        document.getElementById("preview").innerHTML = baseTempl;
        document.getElementById("banner_template").innerHTML = baseTempl; //.replace(/\>/g, ">\n");
        formvalue_update();
      }
      initBanner();

      function getShowDialogFunc() {
        return (
          `
permanentClose=false;
function showDialog() {
  var dialogBaseElm = document.createElement("div");
  var dialogContentElm = document.createElement("div");
  dialogBaseElm.appendChild(dialogContentElm);
  dialogBaseElm.addEventListener("click",function() {document.body.removeChild(this);permanentClose=true;});
  dialogBaseElm.id ="ATDialogBase";
  dialogContentElm.innerHTML = getBannerHTML();
  document.body.appendChild(dialogBaseElm);
}
showScrollPercent = ` +
          window.document.forms[0].showScrollY.value +
          `;
hideScrollPercent = ` +
          window.document.forms[0].hideScrollY.value +
          `;
showFlg = false;
function scrollShowHideCheck() {
  scrollPercent = (window.pageYOffset==0)?0:(window.pageYOffset / (window.document.body.clientHeight - window.innerHeight)) * 100;
  if ((scrollPercent==Infinity)||(scrollPercent < 0)) {
    scrollYMax = window.document.body.scrollHeight - window.document.body.clientHeight;
    scrollPercent = scrollYMax > 0 ? (window.scrollY / scrollYMax) * 100 : 100;
    scrollPercent = scrollPercent > 100 ? 100 : scrollPercent;
  }
  if (!permanentClose &&!showFlg && scrollPercent >= showScrollPercent && scrollPercent <= hideScrollPercent) {
    showDialog();
    initFlg=true;
    showFlg = true;
  }
  if (showFlg && ( Math.floor(scrollPercent) > hideScrollPercent ||  Math.floor(scrollPercent) < showScrollPercent)) {
    showFlg = false;
    document.body.removeChild(document.getElementById("ATDialogBase"));
  }
}`
        ).replace(/\r?\n/g, "");
      }
      // eval(getShowDialogFunc());

      // カウントダウン実行用のJS構築 Editor DialogからもAdobe Targetからも同一コードが動作するように文字列から作成できるように。
      function getCDFunc() {
        return (
          `
var bannerCDTargetDate = new Date("` +
          document.getElementById("banner_CD_date").value +
          `");
var showFlg=false;
var initFlg = false;
function showCountDown() {
  var diff2Dates = (bannerCDTargetDate - new Date());
  var dDays = diff2Dates / (1000 * 60 * 60 * 24);
  diff2Dates = diff2Dates % (1000 * 60 * 60 * 24);
  var dHour = diff2Dates / (1000 * 60 * 60);
  diff2Dates = diff2Dates % (1000 * 60 * 60);
  var dMin = diff2Dates / (1000 * 60);
  diff2Dates = diff2Dates % (1000 * 60);
  var dSec = diff2Dates / 1000;
  var RemainingDays,RemainingHours;
  if((false)&&(dDays*24>48)) CDmsg="" + Math.floor(dDays)+"Days "+Math.floor(dHour)+"Hours "+Math.floor(dMin) + "Minutes " + Math.floor(dSec) + "Seconds";
  if(dDays*24>48) {
    RemainingDays='<div class="_atdialogHMS"><div>'+Math.floor(dDays)+'</div><div class="_atdialogHMSUnit">days</div></div>';
    RemainingHours='<div class="_atdialogHMS"><div>'+Math.floor(dHour)+'</div><div class="_atdialogHMSUnit">hours</div></div>';
  }else{
    RemainingDays='';
    RemainingHours='<div class="_atdialogHMS"><div>'+(Math.floor(dDays)*24+Math.floor(dHour))+'</div><div class="_atdialogHMSUnit">hours</div></div>';
  }
  var RemainingMinutes='<div class="_atdialogHMS"><div>'+Math.floor(dMin)+'</div><div class="_atdialogHMSUnit">mins</div></div>';
  var RemainingSeconds='<div class="_atdialogHMS"><div>'+Math.floor(dSec)+'</div><div class="_atdialogHMSUnit">secs</div></div>';
  var CDmsg = '<div class="_atdialogHMSDiv">'+RemainingDays+RemainingHours+RemainingMinutes+RemainingSeconds+'</div>';
  CDmsg +='<style>._atdialogHMSDiv{display:flex;justify-content: center;}._atdialogHMS{margin-bottom:-5px;margin-right:10px;}._atdialogHMSUnit{margin-top:1px;font-size:10px;} </style>';
  if(diff2Dates<=0) CDmsg="End";
  if(showFlg&&initFlg) document.getElementById("bannerCD").innerHTML = CDmsg;
  if(false)console.log("" + diff2Dates);
  if (diff2Dates > 0) setTimeout(showCountDown, 1000);
}
setTimeout(showCountDown, 1000);`
        ).replace(/\r?\n/g, ""); // remove new lines
      }
      eval(getCDFunc());

      // 実際にPreviewされているHTMLから表示用の文字列を作成 / ATとEditorどちらでも動くようにshowDialog()の中から呼ばれる
      function getBannerHTML() {
        var previewHTML = document.getElementById("preview").innerHTML;
        return previewHTML.trim().replace(/\r?\n/g, ""); // 改行とescape処理
      }
    </script>
    <script>
      $(document).ready(function () {
        $("#ft_color").spectrum({
          flat: false,
          showAlpha: false,
          showPalette: true,
          palette: [
            ["black", "white", "blanchedalmond"],
            ["rgb(255, 128, 0);", "hsv 100 70 50", "lightyellow"],
          ],
          showInitial: true,
          chooseText: "Select",
          cancelText: "Cancel",
          showPaletteOnly: false,
          showSelectionPalette: true,
          preferredFormat: "hex",
          move: function (color) {
            $("#bannerCD").css("color", color);
          },
          change: function (color) {
            // console.log("color:" + color.toHexString());
            initBanner();
            document.getElementById("preview").innerHTML = window.document.forms[0].banner_template.value;
            formvalue_update();
          },
          color: "#fff",
          showInput: true,
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        $("#bk_color").spectrum({
          flat: false,
          showAlpha: true,
          showPalette: true,
          palette: [
            ["black", "white", "blanchedalmond"],
            ["rgb(255, 128, 0);", "hsv 100 70 50", "#D6563A"],
          ],
          showInitial: true,
          chooseText: "Select",
          cancelText: "Cancel",
          showPaletteOnly: false,
          showSelectionPalette: true,
          preferredFormat: "rgb",
          move: function (color) {
            $("#ATbanner").css("background-color", color);
          },
          change: function (color) {
            // console.log("color:" + color.toHexString());
            initBanner();
            document.getElementById("preview").innerHTML = window.document.forms[0].banner_template.value;
            formvalue_update();
          },
          color: "#D6563A",
          showInput: true,
        });
      });
    </script>
  </body>
</html>
